<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>EcoMap: Mapa de Nascentes</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { 
    --primary: #2ecc71; 
    --dark: #1a1a1a; 
    --accent: #3498db; 
    --danger: #e74c3c; 
}
       html, body { 
    height: 100dvh; /* Usa a altura din√¢mica para celular */
    margin: 0; 
    padding: 0; 
    overflow: hidden; 
    background: var(--dark); 
    font-family: 'Segoe UI', sans-serif; 
}
body { 
    display: flex; 
    flex-direction: column; 
    height: 100dvh; 
}
        #header { padding: 12px; background: #222; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; z-index: 1010; }
        #status-bar { font-size: 0.7rem; color: #aaa; padding: 4px; text-align: center; background: #000; z-index: 1009; }
        #map { flex: 1; width: 100%; z-index: 1; background: #111; }
        #action-panel { 
    padding: 12px; 
    background: #222; 
    border-radius: 15px 15px 0 0; 
    box-shadow: 0 -5px 15px rgba(0,0,0,0.5); 
    z-index: 1010;
    padding-bottom: env(safe-area-inset-bottom); /* Prote√ß√£o extra para iPhones */
}
        .input-group { margin-bottom: 8px; }
        label { display: block; font-size: 0.7rem; color: var(--primary); font-weight: bold; margin-bottom: 4px; }
        select, textarea { width: 100%; box-sizing: border-box; background: #333; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; outline: none; }
        button { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-save { background: var(--primary); text-transform: uppercase; }
        .btn-sim { background: var(--accent); font-size: 0.7rem; width: auto; padding: 6px 12px; }
        .pulse { width: 10px; height: 10px; background: var(--primary); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="header">
    <div style="display: flex; align-items: center; gap: 8px;">
        <div class="pulse"></div>
        <div style="line-height: 1;">
            <strong style="color: white; letter-spacing: 1px;">ECO-MAP</strong><br>
            <small style="color: var(--primary); font-size: 0.6rem;">NASCENTES VIVAS</small>
        </div>
    </div>
    <button class="btn-sim" id="sim-btn" onclick="toggleSimulacao()">Modo Real: OFF</button>
</div>

<div id="status-bar">
    ‚òÅÔ∏è <span id="cloud-status">A conectar...</span> | üìù Total: <span id="count">0</span>
</div>

<div id="map"></div>

<div id="action-panel">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;" class="input-group">
        <div>
            <label>üíß ESTADO</label>
            <select id="status-input">
                <option value="preservada">Preservada</option>
                <option value="ameacada">Amea√ßada</option>
                <option value="seca">Seca</option>
            </select>
        </div>
        <div>
            <label>üì∑ IMAGEM</label>
            <button id="photo-btn" style="background: #333; font-size: 0.7rem;" onclick="document.getElementById('photo-input').click()">ANEXAR FOTO</button>
            <input type="file" id="photo-input" accept="image/*" capture="environment" style="display:none" onchange="previewPhoto(this)">
        </div>
    </div>
    <div class="input-group">
        <label>üìù DESCRI√á√ÉO</label>
        <textarea id="desc-input" rows="1" placeholder="Descreva o local..."></textarea>
    </div>
    <button class="btn-save" id="save-btn" onclick="salvarPonto()" disabled>CARREGANDO...</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAojYYMUUXITjqGofL09yTqp87L_wR9494",
        authDomain: "ecomap---nascentes.firebaseapp.com",
        projectId: "ecomap---nascentes",
        storageBucket: "ecomap---nascentes.firebasestorage.app",
        messagingSenderId: "794098061770",
        appId: "1:794098061770:web:b990a689ad4a934dc63f33"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let map, userMarker, currentUser = null, base64Image = null;
    let currentCoords = [-21.805, -43.326]; 
    let isSimulacao = true;
    let watchId = null;

    window.toggleSimulacao = () => {
        const btn = document.getElementById('sim-btn');
        if (!isSimulacao) {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            isSimulacao = true;
            btn.innerText = "Modo Real: OFF";
            btn.style.background = "#3498db";
        } else {
            if ("geolocation" in navigator) {
                btn.innerText = "üõ∞Ô∏è BUSCANDO...";
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        isSimulacao = false;
                        btn.innerText = "Modo Real: ON";
                        btn.style.background = "#2ecc71";
                        currentCoords = [pos.coords.latitude, pos.coords.longitude];
                        userMarker.setLatLng(currentCoords);
                        map.flyTo(currentCoords, 17);
                    },
                    (err) => { alert("Erro GPS: " + err.message); isSimulacao = true; },
                    { enableHighAccuracy: true }
                );
            }
        }
    };

    window.previewPhoto = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = 300;
                    canvas.getContext('2d').drawImage(img, 0, 0, 400, 300);
                    base64Image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('photo-btn').innerText = "‚úÖ FOTO OK";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    window.salvarPonto = async () => {
        if (!currentUser) return alert("Aguardando conex√£o...");
        const desc = document.getElementById('desc-input').value;
        const status = document.getElementById('status-input').value;
        if (!desc) return alert("Descreva a nascente.");

        const btn = document.getElementById('save-btn');
        btn.innerText = "ENVIANDO...";
        btn.disabled = true;

        try {
            await addDoc(collection(db, 'nascentes'), {
                lat: currentCoords[0], lng: currentCoords[1],
                status: status, descricao: desc,
                foto: base64Image,
                data: new Date().toISOString()
            });
            alert("Sucesso!");
            document.getElementById('desc-input').value = "";
            base64Image = null;
            document.getElementById('photo-btn').innerText = "ANEXAR FOTO";
        } catch (e) {
            alert("Erro ao salvar: " + e.message);
        } finally {
            btn.innerText = "üìç REGISTRAR PONTO";
            btn.disabled = false;
        }
    };

    function ouvirDados() {
        onSnapshot(collection(db, 'nascentes'), (snap) => {
            document.getElementById('count').innerText = snap.size;
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    const idDoc = change.doc.id;
                    const cores = { preservada: '#2ecc71', ameacada: '#f1c40f', seca: '#e74c3c' };
                    
                    const m = L.circleMarker([data.lat, data.lng], {
                        radius: 8, fillColor: cores[data.status] || '#3498db', color: "#000", weight: 1, fillOpacity: 1
                    }).addTo(map);

                    let dataExibicao = "Sem data";
                    if (data.data) {
                        const d = new Date(data.data);
                        dataExibicao = d.toLocaleDateString('pt-BR') + " " + d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                    }

                    const fotoHtml = data.foto ? 
                        `<img src="${data.foto}" style="width:100%; border-radius:8px; margin-top:10px;">` : 
                        `<div style="margin-top:10px; font-size:10px; color:#aaa; text-align:center;">Sem foto</div>`;
                    
                    const popupConteudo = `
                        <div style="min-width: 180px; font-family: sans-serif;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <b style="text-transform: uppercase; color: ${cores[data.status]};">${data.status}</b>
                                <span style="font-size: 8px; color: #999;">ID: ${idDoc.slice(-5)}</span>
                            </div>
                            <div style="font-size: 13px; margin: 5px 0;">${data.descricao}</div>
                            ${fotoHtml}
                            <div style="margin-top: 8px; border-top: 1px solid #eee; font-size: 10px; color: #888; text-align: right;">
                                üìÖ ${dataExibicao}
                            </div>
                        </div>
                    `;
                    m.bindPopup(popupConteudo);
                }
            });
        });
    }

    function init() {
        map = L.map('map', { zoomControl: false }).setView(currentCoords, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        userMarker = L.circleMarker(currentCoords, {
            radius: 10, fillColor: "#3498db", color: "#fff", weight: 3, fillOpacity: 0.9
        }).addTo(map);

        map.on('click', (e) => {
            if(isSimulacao) {
                currentCoords = [e.latlng.lat, e.latlng.lng];
                userMarker.setLatLng(e.latlng);
            }
        });

        signInAnonymously(auth).catch(console.error);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('cloud-status').innerText = "Ligado";
                document.getElementById('cloud-status').style.color = "#2ecc71";
                document.getElementById('save-btn').disabled = false;
                document.getElementById('save-btn').innerText = "üìç REGISTRAR PONTO";
                ouvirDados();
            }
        });
        
        setTimeout(() => map.invalidateSize(), 500);
    }

    // Inicia tudo ao carregar a p√°gina
    window.onload = init;
</script>
</body>
</html>